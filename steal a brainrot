local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local HIGHLIGHT_COLOR = Color3.new(0, 1, 0) 
local OUTLINE_COLOR = Color3.new(1, 0, 0) 

local espEnabled = true

-- Cleanup ESP
local function cleanup(character)
    for _, child in pairs(character:GetChildren()) do
        if child.Name == "PlayerESP" or child.Name == "NameESP" then
            child:Destroy()
        end
    end
end

-- Apply ESP
local function applyESP(player, character)
    if not character or not player then return end
    if player == LocalPlayer then return end

    cleanup(character)

    local highlight = Instance.new("Highlight")
    highlight.Name = "PlayerESP"
    highlight.FillColor = HIGHLIGHT_COLOR
    highlight.FillTransparency = 0.5
    highlight.OutlineColor = OUTLINE_COLOR
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Adornee = character
    highlight.Parent = character

    local head = nil
    local retries = 0
    repeat
        head = character:FindFirstChild("Head")
        if not head then
            retries = retries + 1
            task.wait(0.1)
        end
    until head or retries >= 10

    if head then
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "NameESP"
        billboard.Adornee = head
        billboard.Size = UDim2.new(0, 200, 0, 50)
        billboard.StudsOffset = Vector3.new(0, 3, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = head

        local text = Instance.new("TextLabel")
        text.Size = UDim2.new(1, 0, 1, 0)
        text.BackgroundTransparency = 1
        text.Text = player.Name
        text.TextColor3 = HIGHLIGHT_COLOR
        text.TextStrokeTransparency = 0
        text.TextStrokeColor3 = Color3.new(0, 0, 0)
        text.TextScaled = true
        text.Font = Enum.Font.GothamBold
        text.Parent = billboard
    end
end

local function removeESP(character)
    for _, child in pairs(character:GetChildren()) do
        if child.Name == "PlayerESP" or child.Name == "NameESP" then
            child:Destroy()
        end
    end
end

local function toggleESP(enabled)
    espEnabled = enabled
    if not espEnabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player.Character then
                removeESP(player.Character)
            end
        end
    end
end

local function setupPlayer(player)
    if not player.Character then return end
    applyESP(player, player.Character)
end

local function onPlayerAdded(player)
    player.CharacterAdded:Connect(function(character)
        local success, err = pcall(function()
            setupPlayer(player)
        end)
        if not success then
            warn("Error applying ESP to " .. player.Name .. ": " .. err)
        end
    end)
    if player.Character then
        setupPlayer(player)
    end
end

for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        onPlayerAdded(player)
    end
end

Players.PlayerAdded:Connect(onPlayerAdded)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.E then
        toggleESP(not espEnabled)
        print("ESP toggled: " .. tostring(espEnabled))
    end
end)

-- Create UI for open/close toggle and search bar
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "TeleportUI"
ScreenGui.Parent = game:GetService("CoreGui")

-- Toggle Button (Open/Close) - PARENTED TO SCREEN GUI
local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "UIToggleButton"
ToggleButton.Size = UDim2.new(0, 100, 0, 35)
ToggleButton.Position = UDim2.new(0.5, -50, 0.5, -135) 
ToggleButton.Text = "Close"
ToggleButton.Parent = ScreenGui


-- Main Frame (The black block, centered)
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainTeleportFrame"
MainFrame.Size = UDim2.new(0, 400, 0, 200)
MainFrame.Position = UDim2.new(0.5, -200, 0.5, -100)
MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MainFrame.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
MainFrame.BorderSizePixel = 2
MainFrame.Parent = ScreenGui

-- Search Box (White Background)
local TextBox = Instance.new("TextBox")
TextBox.Size = UDim2.new(0, 280, 0, 35)
TextBox.Position = UDim2.new(0, 10, 0, 10) 
TextBox.PlaceholderText = "Enter Player Name"
TextBox.BackgroundColor3 = Color3.new(1, 1, 1) 
TextBox.BackgroundTransparency = 0 
TextBox.TextXAlignment = Enum.TextXAlignment.Left
TextBox.BorderSizePixel = 1
TextBox.Parent = MainFrame

-- Teleport Button
local TeleportBtn = Instance.new("TextButton")
TeleportBtn.Size = UDim2.new(0, 100, 0, 35)
TeleportBtn.Position = UDim2.new(0, 300, 0, 10) 
TeleportBtn.Text = "Teleport"
TeleportBtn.Parent = MainFrame

-- === RESIZE HANDLES (for 4-way resizing) ===
local HANDLE_THICKNESS = 5
local MIN_SIZE = Vector2.new(150, 100) 

-- Top Handle 
local TopHandle = Instance.new("TextButton")
TopHandle.Name = "TopHandle"
TopHandle.Size = UDim2.new(1, 0, 0, HANDLE_THICKNESS) 
TopHandle.Position = UDim2.new(0, 0, 0, 0)
TopHandle.BackgroundTransparency = 1
TopHandle.Text = ""
TopHandle.ZIndex = 2
TopHandle.Parent = MainFrame

-- Bottom Handle
local BottomHandle = Instance.new("TextButton")
BottomHandle.Name = "BottomHandle"
BottomHandle.Size = UDim2.new(1, 0, 0, HANDLE_THICKNESS) 
BottomHandle.Position = UDim2.new(0, 0, 1, -HANDLE_THICKNESS) 
BottomHandle.BackgroundTransparency = 1
BottomHandle.Text = ""
BottomHandle.ZIndex = 2
BottomHandle.Parent = MainFrame

-- Left Handle
local LeftHandle = Instance.new("TextButton")
LeftHandle.Name = "LeftHandle"
LeftHandle.Size = UDim2.new(0, HANDLE_THICKNESS, 1, 0) 
LeftHandle.Position = UDim2.new(0, 0, 0, 0)
LeftHandle.BackgroundTransparency = 1
LeftHandle.Text = ""
LeftHandle.ZIndex = 2
LeftHandle.Parent = MainFrame

-- Right Handle
local RightHandle = Instance.new("TextButton")
RightHandle.Name = "RightHandle"
RightHandle.Size = UDim2.new(0, HANDLE_THICKNESS, 1, 0) 
RightHandle.Position = UDim2.new(1, -HANDLE_THICKNESS, 0, 0)
RightHandle.BackgroundTransparency = 1
RightHandle.Text = ""
RightHandle.ZIndex = 2
RightHandle.Parent = MainFrame


-- Dragging variables (Shared for MainFrame and ToggleButton)
local dragging = false
local draggedObject = nil -- New variable to track which object is being dragged
local dragStart = nil
local startPos = nil
local resizing = false
local resizeHandle = nil
local resizeStart = nil
local startSize = nil

-- Function to start dragging an object
local function startDrag(object, input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        draggedObject = object
        dragStart = input.Position
        startPos = object.Position
    end
end

local function stopDrag()
    dragging = false
    draggedObject = nil
    resizing = false 
    resizeHandle = nil
end

local function doDrag(input)
    if dragging and draggedObject then
        local delta = input.Position - dragStart
        draggedObject.Position = startPos + UDim2.new(0, delta.X, 0, delta.Y)
    end
end

-- Function to start resizing the frame
local function startResize(handle, input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        resizing = true
        resizeHandle = handle.Name
        resizeStart = input.Position
        startSize = MainFrame.Size
        startPos = MainFrame.Position
    end
end

-- Function to perform resizing
local function doResize(input)
    if resizing then
        local delta = input.Position - resizeStart
        
        -- Current frame size and position
        local currentSizeX = startSize.X.Offset
        local currentSizeY = startSize.Y.Offset
        local currentPosX = startPos.X.Offset
        local currentPosY = startPos.Y.Offset

        if resizeHandle == "TopHandle" then
            local newSizeY = currentSizeY - delta.Y
            if newSizeY >= MIN_SIZE.Y then
                MainFrame.Size = UDim2.new(0, currentSizeX, 0, newSizeY)
                MainFrame.Position = UDim2.new(0.5, currentPosX, 0.5, currentPosY + delta.Y)
            end
        elseif resizeHandle == "BottomHandle" then
            local newSizeY = currentSizeY + delta.Y
            if newSizeY >= MIN_SIZE.Y then
                MainFrame.Size = UDim2.new(0, currentSizeX, 0, newSizeY)
            end
        elseif resizeHandle == "LeftHandle" then
            local newSizeX = currentSizeX - delta.X
            if newSizeX >= MIN_SIZE.X then
                MainFrame.Size = UDim2.new(0, newSizeX, 0, currentSizeY)
                MainFrame.Position = UDim2.new(0.5, currentPosX + delta.X, 0.5, currentPosY)
            end
        elseif resizeHandle == "RightHandle" then
            local newSizeX = currentSizeX + delta.X
            if newSizeX >= MIN_SIZE.X then
                MainFrame.Size = UDim2.new(0, newSizeX, 0, currentSizeY)
            end
        end
    end
end

-- Connect drag events for MainFrame movement (only dragging from the non-handle area moves the frame)
MainFrame.InputBegan:Connect(function(input)
    -- Check if input is a left click AND not over a resize handle
    if input.UserInputType == Enum.UserInputType.MouseButton1 and not resizing then
        -- We assume the user is clicking the MainFrame to move it
        startDrag(MainFrame, input)
    end
end)

-- Connect drag event for ToggleButton movement
ToggleButton.InputBegan:Connect(function(input)
    -- Click on the toggle button itself starts movement
    startDrag(ToggleButton, input)
end)


UserInputService.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        doDrag(input)
        doResize(input) 
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        stopDrag()
    end
end)

-- Connect drag events for resizing
TopHandle.InputBegan:Connect(function(input)
    startResize(TopHandle, input)
end)
BottomHandle.InputBegan:Connect(function(input)
    startResize(BottomHandle, input)
end)
LeftHandle.InputBegan:Connect(function(input)
    startResize(LeftHandle, input)
end)
RightHandle.InputBegan:Connect(function(input)
    startResize(RightHandle, input)
end)


-- Toggle open/close logic
local isOpen = true
ToggleButton.MouseButton1Click:Connect(function()
    isOpen = not isOpen
    if isOpen then
        MainFrame.Visible = true
        ToggleButton.Text = "Close"
    else
        MainFrame.Visible = false
        ToggleButton.Text = "Open"
    end
end)

-- Teleport function
local function teleportToPlayer()
    local name = TextBox.Text
    if name == "" then
        warn("Please enter a player name.")
        return
    end
    local targetPlayer = nil
    for _, player in pairs(Players:GetPlayers()) do
        if string.lower(player.Name) == string.lower(name) then
            targetPlayer = player
            break
        end
    end
    if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = targetPlayer.Character.HumanoidRootPart
        local localChar = LocalPlayer.Character
        if localChar and localChar:FindFirstChild("HumanoidRootPart") then
            local localHRP = localChar.HumanoidRootPart
            localHRP.CFrame = hrp.CFrame + Vector3.new(0, 5, 0)
        end
    else
        warn("Player not found or not loaded.")
    end
end

TeleportBtn.MouseButton1Click:Connect(teleportToPlayer)

print("Hi, it is working")
