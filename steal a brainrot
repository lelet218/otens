local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local HIGHLIGHT_COLOR = Color3.new(0, 1, 0) -- Green
local OUTLINE_COLOR = Color3.new(1, 0, 0) -- Red

local espEnabled = true -- Toggle ESP on/off

local function cleanup(character)
    for _, child in pairs(character:GetChildren()) do
        if child.Name == "PlayerESP" or child.Name == "NameESP" then
            child:Destroy()
        end
    end
end

local function applyESP(player, character)
    if not character or not player then return end
    if player == LocalPlayer then return end

    cleanup(character)

    -- Highlight
    local highlight = Instance.new("Highlight")
    highlight.Name = "PlayerESP"
    highlight.FillColor = HIGHLIGHT_COLOR
    highlight.FillTransparency = 0.5
    highlight.OutlineColor = OUTLINE_COLOR
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Adornee = character
    highlight.Parent = character

    -- Wait for the Head
    local head = nil
    local maxRetries = 10
    local retries = 0
    repeat
        head = character:FindFirstChild("Head")
        if not head then
            retries = retries + 1
            task.wait(0.1)
        end
    until head or retries >= maxRetries

    if head then
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "NameESP"
        billboard.Adornee = head
        billboard.Size = UDim2.new(0, 200, 0, 50)
        billboard.StudsOffset = Vector3.new(0, 3, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = head

        local text = Instance.new("TextLabel")
        text.Size = UDim2.new(1, 0, 1, 0)
        text.BackgroundTransparency = 1
        text.Text = player.Name
        text.TextColor3 = HIGHLIGHT_COLOR
        text.TextStrokeTransparency = 0
        text.TextStrokeColor3 = Color3.new(0, 0, 0)
        text.TextScaled = true
        text.Font = Enum.Font.GothamBold
        text.Parent = billboard
    end
end

local function toggleESP(enabled)
    espEnabled = enabled
    -- Optional: add a way to turn off ESP
end

local function setupPlayer(player)
    if not player.Character then return end
    applyESP(player, player.Character)
end

local function onPlayerAdded(player)
    player.CharacterAdded:Connect(function(character)
        -- Wait for character to load
        local success, err = pcall(function()
            setupPlayer(player)
        end)
        if not success then
            warn("Error applying ESP to " .. player.Name .. ": " .. err)
        end
    end)
    -- If character already exists
    if player.Character then
        setupPlayer(player)
    end
end

-- Connect existing players
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        onPlayerAdded(player)
    end
end

-- Listen for new players joining
Players.PlayerAdded:Connect(onPlayerAdded)

-- Optional: toggle ESP with a key
-- Example: press E to toggle
game:GetService("UserInputService").InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.E then
        espEnabled = not espEnabled
        print("ESP toggled: " .. tostring(espEnabled))
        -- Remove existing ESP if toggling off
        if not espEnabled then
            for _, player in pairs(Players:GetPlayers()) do
                if player.Character then
                    cleanup(player.Character)
                end
            end
        end
    end
end)

-- Print confirmation that script is running
print("Hi, it is working")
