local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local HIGHLIGHT_COLOR = Color3.new(0, 1, 0) -- Green for ESP fill
local OUTLINE_COLOR = Color3.new(1, 0, 0) -- Red for ESP outline

local espEnabled = true

-- Cleanup ESP
local function cleanup(character)
    for _, child in pairs(character:GetChildren()) do
        if child.Name == "PlayerESP" or child.Name == "NameESP" then
            child:Destroy()
        end
    end
end

-- Apply ESP
local function applyESP(player, character)
    if not character or not player then return end
    if player == LocalPlayer then return end

    cleanup(character)

    local highlight = Instance.new("Highlight")
    highlight.Name = "PlayerESP"
    highlight.FillColor = HIGHLIGHT_COLOR
    highlight.FillTransparency = 0.5
    highlight.OutlineColor = OUTLINE_COLOR
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Adornee = character
    highlight.Parent = character

    local head = nil
    local retries = 0
    repeat
        head = character:FindFirstChild("Head")
        if not head then
            retries = retries + 1
            task.wait(0.1)
        end
    until head or retries >= 10

    if head then
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "NameESP"
        billboard.Adornee = head
        billboard.Size = UDim2.new(0, 200, 0, 50)
        billboard.StudsOffset = Vector3.new(0, 3, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = head

        local text = Instance.new("TextLabel")
        text.Size = UDim2.new(1, 0, 1, 0)
        text.BackgroundTransparency = 1
        text.Text = player.Name
        text.TextColor3 = HIGHLIGHT_COLOR
        text.TextStrokeTransparency = 0
        text.TextStrokeColor3 = Color3.new(0, 0, 0)
        text.TextScaled = true
        text.Font = Enum.Font.GothamBold
        text.Parent = billboard
    end
end

local function removeESP(character)
    for _, child in pairs(character:GetChildren()) do
        if child.Name == "PlayerESP" or child.Name == "NameESP" then
            child:Destroy()
        end
    end
end

local function toggleESP(enabled)
    espEnabled = enabled
    if not espEnabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player.Character then
                removeESP(player.Character)
            end
        end
    end
end

local function setupPlayer(player)
    if not player.Character then return end
    applyESP(player, player.Character)
end

local function onPlayerAdded(player)
    player.CharacterAdded:Connect(function(character)
        local success, err = pcall(function()
            setupPlayer(player)
        end)
        if not success then
            warn("Error applying ESP to " .. player.Name .. ": " .. err)
        end
    end)
    if player.Character then
        setupPlayer(player)
    end
end

for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        onPlayerAdded(player)
    end
end

Players.PlayerAdded:Connect(onPlayerAdded)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.E then
        toggleESP(not espEnabled)
        print("ESP toggled: " .. tostring(espEnabled))
    end
end)

-- Create UI for open/close toggle and search bar
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "TeleportUI"
ScreenGui.Parent = game:GetService("CoreGui")

-- Main Frame (centered) - SIZE ADJUSTED (400 width, 200 height)
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 400, 0, 200)
MainFrame.Position = UDim2.new(0.5, -200, 0.5, -100) -- Re-centered due to new size
MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MainFrame.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
MainFrame.BorderSizePixel = 2
MainFrame.Parent = ScreenGui

-- Toggle Button (Open/Close) - SIZE ADJUSTED (100 width, 35 height)
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0, 100, 0, 35)
ToggleButton.Position = UDim2.new(0, 10, 0, 10)
ToggleButton.Text = "Close"
ToggleButton.Parent = MainFrame

-- Search Box (White Background, SIZE ADJUSTED: 280 width, 35 height)
local TextBox = Instance.new("TextBox")
TextBox.Size = UDim2.new(0, 280, 0, 35)
TextBox.Position = UDim2.new(0, 10, 0, 60) -- Adjusted Y position for new button height
TextBox.PlaceholderText = "Enter Player Name"
TextBox.BackgroundColor3 = Color3.new(1, 1, 1) -- White background
TextBox.BackgroundTransparency = 0 
TextBox.TextXAlignment = Enum.TextXAlignment.Left
TextBox.BorderSizePixel = 1
TextBox.Parent = MainFrame

-- Teleport Button - SIZE ADJUSTED (100 width, 35 height)
local TeleportBtn = Instance.new("TextButton")
TeleportBtn.Size = UDim2.new(0, 100, 0, 35)
TeleportBtn.Position = UDim2.new(0, 300, 0, 60) -- Adjusted X and Y position to fit new sizes
TeleportBtn.Text = "Teleport"
TeleportBtn.Parent = MainFrame

-- Dragging variables
local dragging = false
local dragStart = nil
local startPos = nil

-- Function to move the frame
local function startDrag(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
    end
end

local function stopDrag()
    dragging = false
end

local function doDrag(input)
    if dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = startPos + UDim2.new(0, delta.X, 0, delta.Y)
    end
end

-- Connect drag events
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        startDrag(input)
    end
end)
MainFrame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        stopDrag()
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        doDrag(input)
    end
end)

-- Toggle open/close
local isOpen = true
ToggleButton.MouseButton1Click:Connect(function()
    isOpen = not isOpen
    if isOpen then
        MainFrame.Visible = true
        TextBox.Visible = true
        TeleportBtn.Visible = true
        ToggleButton.Text = "Close"
    else
        -- When closed, hide search bar and teleport button, keep main frame visible if you want
        TextBox.Visible = false
        TeleportBtn.Visible = false
        ToggleButton.Text = "Open"
    end
end)

-- Teleport function
local function teleportToPlayer()
    local name = TextBox.Text
    if name == "" then
        warn("Please enter a player name.")
        return
    end
    local targetPlayer = nil
    for _, player in pairs(Players:GetPlayers()) do
        if string.lower(player.Name) == string.lower(name) then
            targetPlayer = player
            break
        end
    end
    if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = targetPlayer.Character.HumanoidRootPart
        local localChar = LocalPlayer.Character
        if localChar and localChar:FindFirstChild("HumanoidRootPart") then
            local localHRP = localChar.HumanoidRootPart
            localHRP.CFrame = hrp.CFrame + Vector3.new(0, 5, 0)
        end
    else
        warn("Player not found or not loaded.")
    end
end

TeleportBtn.MouseButton1Click:Connect(teleportToPlayer)

print("Hi, it is working")
